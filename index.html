<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <link rel="manifest" href="manifest.json">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#000000">

    <title>Suburb Tracker v13</title>
    <style>
        body { background-color: #000; color: #fff; font-family: Arial, sans-serif; text-align: center; margin: 0; padding-top: env(safe-area-inset-top, 10px); display: flex; flex-direction: column; align-items: center; height: 100vh; overflow: hidden; }
        
        .controls { width: 90%; display: flex; justify-content: space-between; margin-top: 10px; margin-bottom: 10px; }
        .btn { background-color: #222; color: #fff; border: 1px solid #444; padding: 12px; font-size: 0.9rem; border-radius: 10px; width: 48%; }
        .btn.active { background-color: #28a745; border-color: #1e7e34; }

        /* COMPASS - Half Red / Half Blue */
        #compass-outer {
            width: 100px; height: 100px;
            border: 3px solid #333;
            border-radius: 50%;
            position: relative;
            margin: 10px 0;
            background: #050505;
        }
        #needle-wrapper {
            width: 100%; height: 100%;
            position: absolute;
            transition: transform 0.1s linear;
        }
        .needle-red { 
            position: absolute; top: 10px; left: 48px; 
            width: 4px; height: 40px; background: red; border-radius: 4px 4px 0 0;
        }
        .needle-blue { 
            position: absolute; top: 50px; left: 48px; 
            width: 4px; height: 40px; background: blue; border-radius: 0 0 4px 4px;
        }

        .info-grid { display: flex; justify-content: space-around; flex-wrap: wrap; width: 95%; margin-bottom: 10px; padding-bottom: 10px; border-bottom: 1px solid #222; }
        .info-box { text-align: center; flex: 1; }
        .info-label { font-size: 0.7rem; color: #666; text-transform: uppercase; }
        .info-value { font-size: 1.4rem; font-weight: bold; }
        .sub-text { font-size: 0.8rem; color: #aaa; display: block; }

        #speed-val { color: #0f0; }
        #temp-val { color: #ffa500; }

        #suburb-display { flex-grow: 1; display: flex; flex-direction: column; justify-content: center; width: 100%; }
        .suburb-name { font-size: 3.8rem; font-weight: 900; margin: 0; line-height: 1; }
        .icon-display { font-size: 6rem; margin-bottom: 10px; }
        #last-updated { font-size: 0.75rem; color: #333; margin-top: 15px; }

        #history-overlay { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.95); z-index: 100; flex-direction: column; align-items: center; padding-top: 50px; }
        .history-item { width: 85%; padding: 15px; border-bottom: 1px solid #222; display: flex; justify-content: space-between; align-items: center; }
    </style>
</head>
<body>

    <div class="controls">
        <button id="wake-btn" class="btn" onclick="toggleWake()">Screen: Auto</button>
        <button id="hist-btn" class="btn" onclick="toggleHistory()">History üìú</button>
    </div>

    <div id="compass-outer">
        <div id="needle-wrapper">
            <div class="needle-red"></div>
            <div class="needle-blue"></div>
        </div>
        <span style="position:absolute; top:2px; left:45px; color:red; font-size:12px; font-weight:bold;">N</span>
    </div>

    <div class="info-grid">
        <div class="info-box"><span class="info-label">Speed</span><div id="speed-val" class="info-value">0</div></div>
        <div class="info-box"><span class="info-label">Travel</span><div id="dir-val" class="info-value">--</div></div>
        <div class="info-box"><span class="info-label">Wind</span><div id="wind-val" class="info-value">--</div></div>
        <div class="info-box"><span class="info-label">Temp</span><div id="temp-val" class="info-value">--</div></div>
    </div>

    <div id="suburb-display">
        <div class="icon-display">üõ∞Ô∏è</div>
        <h1 class="suburb-name">Locating...</h1>
        <div id="last-updated">Updating GPS...</div>
    </div>

    <div id="history-overlay">
        <button style="position:absolute; top:20px; right:20px; background:none; border:none; color:#fff; font-size:2rem;" onclick="toggleHistory()">‚úï</button>
        <h2 style="margin-bottom:20px;">Journey Log</h2>
        <button style="background:#d33; color:#fff; border:none; padding:10px 20px; border-radius:5px;" onclick="clearLog()">Clear Records</button>
        <div id="log-content" style="width:100%; overflow-y:auto; margin-top:20px;"></div>
    </div>

    <script>
        let lastSub = ""; let history = JSON.parse(localStorage.getItem('tripLog') || "[]");
        let wakeLock = null; let lastUpdate = 0;

        // --- COMPASS & HEADING ---
        function getCard(deg) { 
            if (deg === null || isNaN(deg)) return "--";
            const dirs = ["N", "NE", "E", "SE", "S", "SW", "W", "NW"];
            return dirs[Math.round(((deg %= 360) < 0 ? deg + 360 : deg) / 45) % 8];
        }

        // Listen for internal phone compass
        window.addEventListener('deviceorientationabsolute', (e) => {
            let heading = e.alpha; // Magnetic North
            if (heading !== null) {
                // We rotate the needle wrapper -heading so red always points North
                document.getElementById('needle-wrapper').style.transform = `rotate(${-heading}deg)`;
            }
        }, true);

        // --- GPS ---
        if ("geolocation" in navigator) {
            navigator.geolocation.watchPosition(pos => {
                const s = pos.coords.speed ? Math.round(pos.coords.speed * 3.6) : 0;
                const h = pos.coords.heading;
                document.getElementById('speed-val').innerText = s + " km/h";
                if (h !== null) document.getElementById('dir-val').innerHTML = `${getCard(h)}<span class="sub-text">${Math.round(h)}¬∞</span>`;

                if (Date.now() - lastUpdate > 30000) {
                    updateLoc(pos.coords.latitude, pos.coords.longitude);
                }
            }, null, { enableHighAccuracy: true });
        }

        async function updateLoc(lat, lon) {
            try {
                const res = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lon}&zoom=14`);
                const data = await res.json();
                let sub = data.address.suburb || data.address.town || data.address.village || "Unknown";
                sub = sub.split(' ').map(w => w[0].toUpperCase() + w.slice(1).toLowerCase()).join(' ');

                if (sub !== lastSub && sub !== "Unknown") {
                    lastSub = sub; lastUpdate = Date.now();
                    
                    // Weather
                    const wRes = await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&current=temperature_2m,wind_speed_10m,wind_direction_10m&timezone=auto`);
                    const w = await wRes.json();
                    
                    document.getElementById('temp-val').innerHTML = Math.round(w.current.temperature_2m) + "¬∞";
                    document.getElementById('wind-val').innerHTML = Math.round(w.current.wind_speed_10m) + "k<span class="sub-text">${getCard(w.current.wind_direction_10m)}</span>";
                    
                    // Display
                    const color = ["#FFD700", "#00FFFF", "#FF69B4", "#ADFF2F", "#FFA500"][Math.floor(Math.random() * 5)];
                    document.querySelector('.suburb-name').innerText = sub;
                    document.querySelector('.suburb-name').style.color = color;
                    
                    const now = new Date();
                    const ts = `${now.toLocaleDateString('en-AU', {weekday:'short', day:'numeric'})} ${now.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'})}`;
                    document.getElementById('last-updated').innerText = `Refreshed: ${now.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'})}`;

                    history.unshift({ name: sub, color, time: ts });
                    localStorage.setItem('tripLog', JSON.stringify(history));
                }
            } catch (e) {}
        }

        function toggleHistory() {
            const o = document.getElementById('history-overlay');
            o.style.display = (o.style.display === "flex") ? "none" : "flex";
            document.getElementById('log-content').innerHTML = history.map(h => `<div class="history-item" style="border-left:4px solid ${h.color}"><b style="color:${h.color}">${h.name}</b><span style="color:#666; font-size:0.8rem;">${h.time}</span></div>`).join('');
        }

        function clearLog() { if(confirm("Delete all?")) { history = []; localStorage.removeItem('tripLog'); toggleHistory(); } }
        async function toggleWake() { 
            if (!wakeLock) { 
                wakeLock = await navigator.wakeLock.request('screen'); 
                document.getElementById('wake-btn').classList.add('active'); 
                document.getElementById('wake-btn').innerText = "Screen: ON";
            } else { 
                wakeLock.release(); wakeLock = null; 
                document.getElementById('wake-btn').classList.remove('active'); 
                document.getElementById('wake-btn').innerText = "Screen: Auto";
            } 
        }
    </script>
</body>
</html>
