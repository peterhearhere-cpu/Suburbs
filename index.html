<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <link rel="manifest" href="manifest.json">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#000000">
    <title>Suburb Tracker v12</title>
    <style>
        body { background-color: #000000; color: #ffffff; font-family: Arial, sans-serif; text-align: center; margin: 0; padding-top: 10px; display: flex; flex-direction: column; align-items: center; height: 98vh; overflow: hidden; }
        .controls { width: 90%; display: flex; justify-content: space-between; margin-bottom: 10px; }
        .btn { background-color: #333; color: #fff; border: 1px solid #555; padding: 10px; font-size: 0.9rem; border-radius: 10px; cursor: pointer; width: 48%; }
        .btn.active { background-color: #28a745; border-color: #1e7e34; }
        
        /* COMPASS STYLING */
        #compass-container {
            width: 80px; height: 80px;
            border: 2px solid #444;
            border-radius: 50%;
            position: relative;
            margin-bottom: 10px;
            background: radial-gradient(circle, #111 0%, #000 100%);
        }
        #compass-needle {
            width: 4px; height: 60px;
            position: absolute;
            top: 10px; left: 38px;
            transition: transform 0.2s ease-out;
            transform-origin: center center;
        }
        .north { width: 100%; height: 50%; background-color: red; border-radius: 2px 2px 0 0; }
        .south { width: 100%; height: 50%; background-color: blue; border-radius: 0 0 2px 2px; }

        .info-grid { display: flex; justify-content: space-around; flex-wrap: wrap; width: 95%; margin-bottom: 5px; border-bottom: 1px solid #333; padding-bottom: 10px; gap: 5px; }
        .info-box { text-align: center; flex: 1 1 30%; }
        .info-label { font-size: 0.7rem; color: #888; }
        .info-value { font-size: 1.3rem; font-weight: bold; line-height: 1.1; }
        .sub-value { font-size: 0.8rem; color: #ccc; }
        
        #speed-val { color: #00ff00; } #heading-val { color: #00bfff; } #temp-val { color: #ffcc00; }
        
        #suburb-display { flex-grow: 1; display: flex; flex-direction: column; justify-content: center; align-items: center; width: 100%; }
        .suburb-name { font-size: 3.5rem; font-weight: 900; line-height: 1.0; margin-top: 5px; }
        .icon-display { font-size: 5.5rem; height: 100px; }
        #last-updated { font-size: 0.7rem; color: #444; margin-top: 15px; }

        #history-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.95); z-index: 100; overflow-y: auto; flex-direction: column; align-items: center; padding-top: 50px; }
        .history-item { font-size: 1.1rem; padding: 12px; border-bottom: 1px solid #333; width: 85%; display: flex; justify-content: space-between; align-items: center; }
    </style>
</head>
<body>

    <div class="controls">
        <button id="wakelock-btn" class="btn" onclick="toggleWakeLock()">Screen: Auto üì±</button>
        <button id="list-btn" class="btn" onclick="toggleHistory()">History üìú</button>
    </div>

    <div id="compass-container">
        <div id="compass-needle">
            <div class="north"></div>
            <div class="south"></div>
        </div>
        <div style="position:absolute; top:-15px; left:33px; font-size:10px; color:red; font-weight:bold;">N</div>
    </div>

    <div class="info-grid">
        <div class="info-box"><div class="info-label">SPEED</div><div id="speed-val" class="info-value">0</div></div>
        <div class="info-box"><div class="info-label">TRAVEL</div><div id="heading-val" class="info-value">--</div></div>
        <div class="info-box"><div class="info-label">WIND</div><div id="wind-val" class="info-value">--</div></div>
        <div class="info-box"><div class="info-label">TEMP</div><div id="temp-val" class="info-value">--¬∞</div></div>
        <div class="info-box"><div class="info-label">UV</div><div id="uv-val" class="info-value">--</div></div>
    </div>
    
    <div id="suburb-display">
        <div class="icon-display">üõ∞Ô∏è</div>
        <div class="suburb-name">Locating...</div>
        <div id="last-updated">Waiting...</div>
    </div>

    <div id="history-overlay">
        <button style="position:absolute; top:15px; right:15px; font-size:2rem; color:white; background:none; border:none;" onclick="toggleHistory()">‚úñ</button>
        <h2 style="color:white;">JOURNEY LOG</h2>
        <button style="background:#dc3545; color:white; border:none; padding:8px; border-radius:5px;" onclick="clearHistory()">Clear All</button>
        <div id="history-content" style="width:100%; margin-top:20px;"></div>
    </div>

    <script>
        let lastSuburb = ""; let suburbHistory = JSON.parse(localStorage.getItem('suburbJourneyLog') || "[]");
        let wakeLock = null; let lastUpdateTime = 0;

        function getCardinal(angle) { if (angle === null || isNaN(angle)) return "--"; const directions = ["N", "NE", "E", "SE", "S", "SW", "W", "NW"]; return directions[Math.round(((angle %= 360) < 0 ? angle + 360 : angle) / 45) % 8]; }

        if ("geolocation" in navigator) { navigator.geolocation.watchPosition(updateLocation, console.error, { enableHighAccuracy: true }); }

        async function updateLocation(position) {
            const speed = position.coords.speed ? Math.round(position.coords.speed * 3.6) : 0;
            const heading = position.coords.heading;
            
            document.getElementById('speed-val').innerText = speed + " km/h";

            // Update Compass and Travel Direction
            if (heading !== null && !isNaN(heading)) {
                document.getElementById('heading-val').innerHTML = `${getCardinal(heading)}<br><span class="sub-value">${Math.round(heading)}¬∞</span>`;
                // Rotating the needle opposite to heading keeps it pointing North
                document.getElementById('compass-needle').style.transform = `rotate(${-heading}deg)`;
            }

            const now = Date.now();
            if (now - lastUpdateTime < 30000) return;

            try {
                const res = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${position.coords.latitude}&lon=${position.coords.longitude}&zoom=14`);
                const data = await res.json();
                let sub = toTitleCase(data.address.suburb || data.address.town || data.address.village || "Unknown");
                if (sub !== lastSuburb && sub !== "Unknown") {
                    lastSuburb = sub;
                    updateDisplay(sub, position.coords.latitude, position.coords.longitude);
                }
            } catch (e) {}
        }

        async function updateDisplay(name, lat, lon) {
            const colors = ["#FFD700", "#00FFFF", "#FF69B4", "#ADFF2F", "#FFA500", "#FFFFFF"];
            const color = colors[Math.floor(Math.random() * colors.length)];
            const iconSet = { "Drouin": "üå≥", "Warragul": "üêÑ", "Chelsea": "üèñÔ∏è", "Moorabbin": "‚öΩ", "Frankston": "üèôÔ∏è" };
            
            document.querySelector('.suburb-name').innerText = name;
            document.querySelector('.suburb-name').style.color = color;
            document.querySelector('.icon-display').innerHTML = iconSet[name] || "üìç";
            
            const time = new Date();
            document.getElementById('last-updated').innerText = `Updated: ${time.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'})}`;
            
            // Log History
            const logEntry = { name, color, time: `${time.toLocaleDateString('en-AU', {weekday:'short', day:'numeric'})} ${time.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'})}` };
            suburbHistory.unshift(logEntry);
            localStorage.setItem('suburbJourneyLog', JSON.stringify(suburbHistory));

            // Weather
            const wRes = await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&current=temperature_2m,uv_index,wind_speed_10m,wind_direction_10m&timezone=auto`);
            const wData = await wRes.json();
            document.getElementById('temp-val').innerText = Math.round(wData.current.temperature_2m) + "¬∞";
            document.getElementById('uv-val').innerText = wData.current.uv_index;
            document.getElementById('wind-val').innerHTML = `${Math.round(wData.current.wind_speed_10m)}k<br><span class="sub-value">${getCardinal(wData.current.wind_direction_10m)}</span>`;
        }

        function toggleHistory() { 
            const o = document.getElementById('history-overlay');
            o.style.display = (o.style.display === "flex") ? "none" : "flex";
            if(o.style.display === "flex") {
                document.getElementById('history-content').innerHTML = suburbHistory.map(h => `<div class="history-item" style="border-left:4px solid ${h.color}"><b style="color:${h.color}">${h.name}</b><span style="color:#888; font-size:0.8rem;">${h.time}</span></div>`).join('');
            }
        }
        function clearHistory() { if(confirm("Clear?")) { suburbHistory = []; localStorage.removeItem('suburbJourneyLog'); toggleHistory(); } }
        function toTitleCase(s) { return s.toLowerCase().split(' ').map(w => w.charAt(0).toUpperCase() + w.slice(1)).join(' '); }
        async function toggleWakeLock() { if (!wakeLock) { wakeLock = await navigator.wakeLock.request('screen'); document.getElementById('wakelock-btn').classList.add('active'); } else { wakeLock.release(); wakeLock = null; document.getElementById('wakelock-btn').classList.remove('active'); } }
    </script>
</body>
</html>
