<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <link rel="manifest" href="manifest.json">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#000000">

    <title>Suburb Tracker v17</title>
    <style>
        /* Added 35px padding-top for extra black space at the top */
        body { background-color: #000; color: #fff; font-family: 'Segoe UI', Arial, sans-serif; text-align: center; margin: 0; padding-top: 35px; display: flex; flex-direction: column; align-items: center; height: 100vh; overflow: hidden; }
        
        .controls { width: 92%; display: flex; justify-content: space-between; margin-bottom: 25px; }
        .btn { background-color: #1a1a1a; color: #eee; border: 1px solid #333; padding: 12px; font-size: 0.9rem; border-radius: 12px; width: 47%; font-weight: bold; }
        .btn.active { background-color: #2e7d32; border-color: #4caf50; color: white; }

        /* COMPASS */
        #compass-box {
            width: 100px; height: 100px;
            border: 2px solid #222;
            border-radius: 50%;
            position: relative;
            margin-bottom: 25px; 
            background: radial-gradient(circle, #0a0a0a 0%, #000 100%);
        }
        #needle-pivot { width: 100%; height: 100%; position: absolute; transition: transform 0.15s linear; }
        .needle-n { position: absolute; top: 12px; left: 48px; width: 4px; height: 38px; background: #ff0000; border-radius: 4px 4px 0 0; }
        .needle-s { position: absolute; top: 50px; left: 48px; width: 4px; height: 38px; background: #0077ff; border-radius: 0 0 4px 4px; }

        /* INFO GRID - Split into two rows */
        .info-container { width: 95%; margin-bottom: 10px; padding-bottom: 15px; border-bottom: 1px solid #111; display: flex; flex-direction: column; align-items: center; gap: 15px; }
        .info-row-3 { display: grid; grid-template-columns: repeat(3, 1fr); width: 100%; gap: 8px; }
        .info-row-2 { display: grid; grid-template-columns: repeat(2, 1fr); width: 66%; gap: 8px; }
        .info-box { display: flex; flex-direction: column; align-items: center; }
        
        /* Labels updated to white */
        .info-label { font-size: 1.2rem; color: #ffffff; text-transform: uppercase; font-weight: bold; margin-bottom: 5px; }
        .info-value { font-size: 1.45rem; font-weight: 900; color: #00ff66; letter-spacing: -0.5px; }
        .sub-text { font-size: 0.9rem; color: #ffff00; font-weight: bold; display: block; }

        /* MAIN DISPLAY AREA */
        #suburb-display { flex-grow: 1; display: flex; flex-direction: column; justify-content: center; width: 100%; }
        .icon-display { font-size: 6.5rem; margin-bottom: 10px; }
        .suburb-name { font-size: 4rem; font-weight: 900; margin: 0; line-height: 0.9; text-transform: uppercase; }
        
        .about-btn { background: none; border: 1px solid #222; color: #444; padding: 8px 15px; border-radius: 20px; font-size: 0.8rem; margin-top: 20px; cursor: pointer; }

        /* OVERLAYS */
        .overlay { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.98); z-index: 100; flex-direction: column; align-items: center; padding-top: 60px; }
        .history-item { width: 88%; padding: 18px; border-bottom: 1px solid #111; display: flex; justify-content: space-between; align-items: center; }
    </style>
</head>
<body>

    <div class="controls">
        <button id="wake-btn" class="btn" onclick="toggleWake()">Always On</button>
        <button id="hist-btn" class="btn" onclick="toggleHistory()">Log üìú</button>
    </div>

    <div id="compass-box">
        <div id="needle-pivot"><div class="needle-n"></div><div class="needle-s"></div></div>
        <span style="position:absolute; top:-18px; left:43px; color:red; font-size:11px; font-weight:bold;">NORTH</span>
    </div>

    <div class="info-container">
        <div class="info-row-3">
            <div class="info-box"><span class="info-label">Speed</span><div id="speed-val" class="info-value">0 km / h</div></div>
            <div class="info-box"><span class="info-label">Travel</span><div id="heading-val" class="info-value">--</div></div>
            <div class="info-box"><span class="info-label">Wind</span><div id="wind-val" class="info-value">--</div></div>
        </div>
        <div class="info-row-2">
            <div class="info-box"><span class="info-label">Temp</span><div id="temp-val" class="info-value">--</div></div>
            <div class="info-box"><span class="info-label">UV</span><div id="uv-val" class="info-value">--</div></div>
        </div>
    </div>

    <div id="suburb-display">
        <div class="icon-display">üõ∞Ô∏è</div>
        <h1 class="suburb-name">Locating...</h1>
        <button class="about-btn" onclick="toggleAbout()">About This App</button>
        <div id="last-updated" style="font-size: 0.7rem; color: #222; margin-top: 10px;">GPS Standing By</div>
    </div>

    <div id="history-overlay" class="overlay">
        <button style="position:absolute; top:20px; right:25px; background:none; border:none; color:#fff; font-size:2.5rem;" onclick="toggleHistory()">‚úï</button>
        <h2 style="margin-bottom:20px;">JOURNEY LOG</h2>
        <button style="background:#b71c1c; color:#fff; border:none; padding:12px 24px; border-radius:8px; font-weight:bold;" onclick="clearLog()">Clear History</button>
        <div id="log-content" style="width:100%; overflow-y:auto; margin-top:30px;"></div>
    </div>

    <div id="about-overlay" class="overlay">
        <button style="position:absolute; top:20px; right:25px; background:none; border:none; color:#fff; font-size:2.5rem;" onclick="toggleAbout()">‚úï</button>
        <h2 style="color:#00ff66;">ABOUT TRACKER</h2>
        <div style="width: 80%; text-align: left; line-height: 1.6; color: #ccc;">
            <p>Welcome, this app is designed to show you the names of the suburbs you pass through as you travel. The Always On button will keep the app on whilst your travelling and the Log button will give you a history of the suburbs you travel through with a time stamp.</p>
        </div>
    </div>

    <script>
        let lastSub = ""; let history = JSON.parse(localStorage.getItem('peteTripLog') || "[]");
        let wakeLock = null; let lastUpdate = 0;
        let lastLat = null; let lastLon = null;

        function getCard(deg) { 
            if (deg === null || isNaN(deg)) return "--";
            const dirs = ["N", "NE", "E", "SE", "S", "SW", "W", "NW"];
            return dirs[Math.round(((deg %= 360) < 0 ? deg + 360 : deg) / 45) % 8];
        }

        // Haversine formula to calculate distance in meters between two coordinates
        function calcDist(lat1, lon1, lat2, lon2) {
            const R = 6371e3; 
            const p1 = lat1 * Math.PI/180, p2 = lat2 * Math.PI/180;
            const dp = (lat2-lat1) * Math.PI/180, dl = (lon2-lon1) * Math.PI/180;
            const a = Math.sin(dp/2) * Math.sin(dp/2) + Math.cos(p1) * Math.cos(p2) * Math.sin(dl/2) * Math.sin(dl/2);
            return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
        }

        // Handle Compass Orientation
        function handleOrientation(e) {
            if (e.alpha !== null) document.getElementById('needle-pivot').style.transform = `rotate(${-e.alpha}deg)`;
        }

        // Initialize compass immediately if permissions aren't required
        if (typeof DeviceOrientationEvent !== 'undefined' && typeof DeviceOrientationEvent.requestPermission !== 'function') {
            window.addEventListener('deviceorientationabsolute', handleOrientation, true);
        }

        if ("geolocation" in navigator) {
            navigator.geolocation.watchPosition(pos => {
                const s = pos.coords.speed ? Math.round(pos.coords.speed * 3.6) : 0;
                document.getElementById('speed-val').innerText = s + " km / h";
                
                // Use GPS heading if moving > 5km/h (more accurate in cars)
                if (s > 5 && pos.coords.heading !== null) {
                    document.getElementById('heading-val').innerHTML = `${getCard(pos.coords.heading)}<span class="sub-text">${Math.round(pos.coords.heading)}¬∞</span>`;
                    document.getElementById('needle-pivot').style.transform = `rotate(${-pos.coords.heading}deg)`;
                } else if (pos.coords.heading !== null) {
                    document.getElementById('heading-val').innerHTML = `${getCard(pos.coords.heading)}<span class="sub-text">${Math.round(pos.coords.heading)}¬∞</span>`;
                }

                let dist = 0;
                if (lastLat !== null && lastLon !== null) {
                    dist = calcDist(lastLat, lastLon, pos.coords.latitude, pos.coords.longitude);
                }

                // Update if we've moved more than 400 meters OR if it's our very first location check
                if (lastLat === null || dist > 400) {
                    updateLoc(pos.coords.latitude, pos.coords.longitude);
                    lastLat = pos.coords.latitude;
                    lastLon = pos.coords.longitude;
                }
            }, (err) => {
                document.getElementById('last-updated').innerText = "GPS Error: " + err.message;
            }, { enableHighAccuracy: true, maximumAge: 0 });
        }

        async function updateLoc(lat, lon) {
            try {
                const res = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lon}&zoom=14`);
                const data = await res.json();
                let sub = data.address.suburb || data.address.town || data.address.village || "Unknown";
                sub = sub.split(' ').map(w => w[0].toUpperCase() + w.slice(1).toLowerCase()).join(' ');

                if (sub !== lastSub && sub !== "Unknown") {
                    lastSub = sub; lastUpdate = Date.now();
                    
                    // Added uv_index to the API call
                    const wRes = await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&current=temperature_2m,wind_speed_10m,wind_direction_10m,uv_index&timezone=auto`);
                    const w = await wRes.json();
                    document.getElementById('temp-val').innerText = Math.round(w.current.temperature_2m) + "¬∞";
                    document.getElementById('wind-val').innerHTML = `${Math.round(w.current.wind_speed_10m)}k<span class="sub-text">${getCard(w.current.wind_direction_10m)}</span>`;
                    document.getElementById('uv-val').innerText = w.current.uv_index.toFixed(1);
                    
                    const color = ["#FFD700", "#00FFFF", "#FF69B4", "#ADFF2F", "#FFA500"][Math.floor(Math.random() * 5)];
                    document.querySelector('.suburb-name').innerText = sub;
                    document.querySelector('.suburb-name').style.color = color;
                    
                    const now = new Date();
                    history.unshift({ name: sub, color, time: `${now.toLocaleDateString('en-AU', {weekday:'short', day:'numeric'})} ${now.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'})}` });
                    localStorage.setItem('peteTripLog', JSON.stringify(history));
                    document.getElementById('last-updated').innerText = `Updated: ${now.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'})}`;
                }
            } catch (e) {}
        }

        function toggleHistory() {
            const o = document.getElementById('history-overlay');
            o.style.display = (o.style.display === "flex") ? "none" : "flex";
            document.getElementById('log-content').innerHTML = history.map(h => `<div class="history-item" style="border-left:5px solid ${h.color}"><b style="color:${h.color}">${h.name}</b><span style="color:#444; font-size:0.8rem;">${h.time}</span></div>`).join('');
        }

        function toggleAbout() {
            const o = document.getElementById('about-overlay');
            o.style.display = (o.style.display === "flex") ? "none" : "flex";
        }

        function clearLog() { if(confirm("Clear log?")) { history = []; localStorage.removeItem('peteTripLog'); toggleHistory(); } }
        
        async function toggleWake() { 
            const b = document.getElementById('wake-btn');
            
            // Ask for compass permission if on a device that requires it (like iOS)
            if (typeof DeviceOrientationEvent !== 'undefined' && typeof DeviceOrientationEvent.requestPermission === 'function') {
                try {
                    const permission = await DeviceOrientationEvent.requestPermission();
                    if (permission === 'granted') window.addEventListener('deviceorientationabsolute', handleOrientation, true);
                } catch (e) {}
            }

            if (!wakeLock) { 
                try {
                    wakeLock = await navigator.wakeLock.request('screen'); 
                    b.classList.add('active');
                } catch (err) {}
            } else { 
                wakeLock.release(); wakeLock = null; 
                b.classList.remove('active');
            } 
        }

        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                const blob = new Blob(['self.addEventListener("fetch", (e) => e.respondWith(fetch(e.request)));'], {type: 'text/javascript'});
                navigator.serviceWorker.register(URL.createObjectURL(blob));
            });
        }
    </script>
</body>
</html>
